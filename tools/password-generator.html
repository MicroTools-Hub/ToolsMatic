<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Password Generator with Strength Analysis | ToolsMatic</title>
  <meta name="description" content="Generate ultra-secure passwords with real-time strength analysis. Smart leet-speak transformation, entropy calculation, pattern detection, and memorable password creation. 100% client-side and private.">
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="stylesheet" href="../assets/styles.css">
  <script src="../assets/site.js" defer></script>
  <style>
    .strength-meter-container {
      margin: 20px 0;
      padding: 20px;
      background: var(--surface);
      border-radius: 10px;
      border: 1px solid var(--border);
    }
    
    .strength-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .strength-score {
      font-size: 32px;
      font-weight: bold;
      color: var(--primary);
    }
    
    .strength-label {
      font-size: 18px;
      font-weight: 600;
    }
    
    .strength-bar {
      height: 12px;
      background: var(--border);
      border-radius: 6px;
      overflow: hidden;
      margin: 15px 0;
    }
    
    .strength-bar-fill {
      height: 100%;
      transition: width 0.3s ease, background-color 0.3s ease;
      border-radius: 6px;
    }
    
    .strength-weak { background: linear-gradient(90deg, #ef4444, #dc2626); }
    .strength-fair { background: linear-gradient(90deg, #f59e0b, #d97706); }
    .strength-good { background: linear-gradient(90deg, #3b82f6, #2563eb); }
    .strength-strong { background: linear-gradient(90deg, #10b981, #059669); }
    .strength-very-strong { background: linear-gradient(90deg, #22c55e, #16a34a); }
    
    .strength-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 15px;
    }
    
    .strength-detail-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    
    .check-icon { color: #22c55e; font-weight: bold; }
    .x-icon { color: #ef4444; font-weight: bold; }
    
    .password-display {
      position: relative;
      padding: 20px;
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 18px;
      word-break: break-all;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 15px 0;
      transition: all 0.2s;
    }
    
    .password-display:hover {
      border-color: var(--primary);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .leet-preview {
      background: var(--surface);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid var(--border);
      margin-top: 10px;
      font-size: 13px;
    }
    
    .leet-preview-label {
      color: var(--muted);
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .leet-transform {
      font-family: 'Courier New', monospace;
      color: var(--primary);
      font-size: 16px;
    }
    
    .feedback-list {
      margin-top: 15px;
      padding-left: 0;
      list-style: none;
    }
    
    .feedback-item {
      padding: 8px 12px;
      margin: 6px 0;
      border-radius: 6px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .feedback-warning {
      background: rgba(245, 158, 11, 0.1);
      border-left: 3px solid #f59e0b;
      color: #d97706;
    }
    
    .feedback-success {
      background: rgba(34, 197, 94, 0.1);
      border-left: 3px solid #22c55e;
      color: #16a34a;
    }
    
    .feedback-info {
      background: rgba(59, 130, 246, 0.1);
      border-left: 3px solid #3b82f6;
      color: #2563eb;
    }
    
    @media (max-width: 768px) {
      .strength-details {
        grid-template-columns: 1fr;
      }
      
      .password-display {
        font-size: 14px;
        padding: 15px;
      }
    }
  </style>
  <script>
    window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
  </script>
  <script defer src="/_vercel/insights/script.js"></script>
</head>
<body>
  <header>
    <div class="nav">
      <a class="brand" href="/">ToolsMatic</a>
      <div class="nav-links">
        <a href="/" class="nav-btn">All tools</a>
        <button id="theme-toggle" class="theme-toggle" title="Toggle dark/light mode">üåô</button>
      </div>
    </div>
  </header>

  <main>
    <section class="tool-shell">
      <h1>Advanced Password Generator</h1>

      <!-- User-provided memorable seed -->
      <div class="inline-controls" style="align-items:flex-end;margin-bottom:14px;gap:12px;">
        <label class="label" style="flex:1;">Start from your own word
          <input id="user-word" placeholder="Type a word or short phrase" style="margin-top:6px;">
        </label>
        <button id="user-word-generate" class="ghost" style="margin-bottom:2px;">‚ú® Build a memorable password</button>
      </div>
      <div class="muted-text" style="margin-top:-6px;margin-bottom:8px;">We auto-use Memorable mode with leet, year, and symbols to keep strength high.</div>
      
      <!-- Mode & Policy Selection -->
      <div class="two-col">
        <label class="label" style="margin-bottom:4px;">Mode
          <select id="mode" style="width:100%;margin-top:4px;">
            <option value="password" selected>Random Password</option>
            <option value="memorable">Memorable (Word-Based)</option>
            <option value="passphrase">Passphrase (Diceware)</option>
          </select>
        </label>
        <label class="label" style="margin-bottom:4px;">Policy Preset
          <select id="policy" style="width:100%;margin-top:4px;">
            <option value="custom" selected>Custom</option>
            <option value="ultra">Ultra Secure (32 chars)</option>
            <option value="nist">NIST Standard (16 chars)</option>
            <option value="long">Long No Symbols (20 chars)</option>
            <option value="owasp">OWASP-Friendly (14 chars)</option>
            <option value="diceware">Diceware (5 words)</option>
          </select>
        </label>
      </div>

      <!-- Random Password Options -->
      <div id="password-options">
        <label class="label" for="length">Password Length</label>
        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
          <input id="length" type="range" min="8" max="64" value="16" style="flex: 1;">
          <input id="length-display" type="number" min="8" max="64" value="16" class="small-input" style="width: 70px;">
        </div>
        
        <div class="inline-controls">
          <label><input type="checkbox" id="upper" checked> Uppercase (A-Z)</label>
          <label><input type="checkbox" id="lower" checked> Lowercase (a-z)</label>
          <label><input type="checkbox" id="numbers" checked> Numbers (0-9)</label>
          <label><input type="checkbox" id="symbols"> Symbols (!@#$%)</label>
        </div>
        <div class="inline-controls" style="margin-top:8px;">
          <label><input type="checkbox" id="no-ambig"> Avoid lookalikes (O0 l1 I|)</label>
          <label><input type="checkbox" id="pronounceable"> Make pronounceable</label>
        </div>
      </div>

      <!-- Memorable Password Options -->
      <div id="memorable-options" style="display:none;">
        <label class="label" for="base-words">Enter Your Words or Phrase</label>
        <input id="base-words" placeholder="e.g., banana coffee keyboard" style="margin-bottom: 12px;">
        <div id="leet-preview-box" class="leet-preview" style="display: none;">
          <div class="leet-preview-label">üîê Leet-Speak Preview:</div>
          <div class="leet-transform" id="leet-preview"></div>
        </div>
        <div class="inline-controls" style="margin-top:12px;">
          <label><input type="checkbox" id="leet-speak" checked> Apply leet-speak (a‚Üí@, e‚Üí3, etc.)</label>
          <label><input type="checkbox" id="add-year" checked> Add year suffix (2026)</label>
          <label><input type="checkbox" id="add-symbols-mem"> Add symbol prefix/suffix</label>
        </div>
        <div class="inline-controls" style="margin-top:8px;">
          <label>Capitalization:
            <select id="cap-mode" style="margin-left: 8px;">
              <option value="title">Title Case</option>
              <option value="random">Random Mix</option>
              <option value="first">First Letter Only</option>
            </select>
          </label>
        </div>
      </div>

      <!-- Passphrase Options -->
      <div id="passphrase-options" style="display:none;">
        <label class="label" for="words">Words per Passphrase</label>
        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
          <input id="words-range" type="range" min="3" max="10" value="5" style="flex: 1;">
          <input id="words" class="small-input" type="number" value="5" min="3" max="10" style="width: 70px;">
        </div>
        <div class="inline-controls" style="margin-top:8px;">
          <label style="flex:1;">Separator
            <input id="separator" placeholder="-" value="-" style="margin-top: 4px;">
          </label>
          <label style="flex:1;">Casing
            <select id="case-mode" style="width:100%;margin-top:4px;">
              <option value="lower">lowercase</option>
              <option value="title">Title Case</option>
              <option value="upper">UPPERCASE</option>
            </select>
          </label>
          <label><input type="checkbox" id="add-number" checked> Add number suffix</label>
        </div>
      </div>

      <!-- Generate Buttons -->
      <div class="inline-controls" style="margin-top:20px;">
        <button id="generate" data-primary>üé≤ Generate Password</button>
        <button id="copy" class="ghost">üìã Copy</button>
        <button id="regenerate" class="ghost">‚Üª Regenerate</button>
      </div>

      <!-- Password Display -->
      <div class="password-display" id="password">Click "Generate Password" to create a secure password</div>

      <!-- Strength Meter -->
      <div class="strength-meter-container">
        <div class="strength-header">
          <div>
            <div class="strength-label" id="strength-label">Not Generated</div>
            <div style="font-size: 12px; color: var(--muted); margin-top: 4px;" id="entropy-display">Entropy: 0 bits</div>
          </div>
          <div class="strength-score" id="strength-score">‚Äî</div>
        </div>
        <div class="strength-bar">
          <div class="strength-bar-fill" id="strength-fill" style="width: 0%"></div>
        </div>
        <div class="strength-details">
          <div class="strength-detail-item">
            <span id="check-length" class="x-icon">‚úó</span>
            <span>Length (8+ chars)</span>
          </div>
          <div class="strength-detail-item">
            <span id="check-uppercase" class="x-icon">‚úó</span>
            <span>Uppercase letters</span>
          </div>
          <div class="strength-detail-item">
            <span id="check-lowercase" class="x-icon">‚úó</span>
            <span>Lowercase letters</span>
          </div>
          <div class="strength-detail-item">
            <span id="check-numbers" class="x-icon">‚úó</span>
            <span>Numbers</span>
          </div>
          <div class="strength-detail-item">
            <span id="check-symbols" class="x-icon">‚úó</span>
            <span>Symbols</span>
          </div>
          <div class="strength-detail-item">
            <span id="check-variety" class="x-icon">‚úó</span>
            <span>Character variety</span>
          </div>
        </div>
        <ul class="feedback-list" id="feedback-list"></ul>
      </div>

      <div class="muted-text" style="margin-top: 15px;">üí° Tip: Ctrl/Cmd+Enter to generate ¬∑ Esc to clear input</div>

      <!-- History -->
      <h3 style="margin-top:24px;">Recent Passwords <span class="tag">Local Only</span></h3>
      <div class="history-list" id="history"></div>
    </section>


    <section class="section" aria-labelledby="pg-what">
      <h2 id="pg-what">What is This Tool?</h2>
      <p>The Advanced Password Generator from ToolsMatic creates ultra-secure passwords with real-time strength analysis and intelligent pattern detection. Choose from three generation modes: Random (traditional strong passwords), Memorable (word-based with smart leet-speak transformation), and Passphrase (Diceware-style word combinations). Get instant feedback with a 0-100 security score, entropy calculation in bits, character variety analysis, and specific recommendations to improve password strength. Perfect for creating secure credentials for any account, API, database, or encrypted system.</p>
      
      <h2>Generation Modes Explained</h2>
      <p><strong>Random Password Mode:</strong> Generates cryptographically random passwords using customizable character sets. Control length (8-64 characters), include/exclude uppercase, lowercase, numbers, and symbols. Option to avoid visually ambiguous characters (O/0, l/1, I/|) for typing accuracy. Ideal for maximum security when memorization isn't required‚Äîuse with a password manager.</p>
      
      <p><strong>Memorable Mode (Word-Based):</strong> Transforms your own words into secure passwords using intelligent leet-speak substitutions. For example, "banana coffee" becomes "B@n@n@-C0ff33-2026!" with strategic character replacements (a‚Üí@, e‚Üí3, o‚Üí0, s‚Üí$, i‚Üí!). Add optional year suffix and symbol prefix/suffix for enhanced security. Perfect for creating passwords you can actually remember while maintaining high entropy.</p>
      
      <p><strong>Passphrase Mode (Diceware):</strong> Generates memorable passphrases using words from a 500+ word dictionary (Diceware method). Creates combinations like "Dolphin-Crystal-Beacon-Meadow-42" that are both secure (high entropy) and easy to remember. Configure word count (3-10 words), separator character, capitalization style, and optional number suffix. Recommended for master passwords and primary account credentials.</p>
      
      <h2>Understanding the Strength Analysis</h2>
      <p><strong>Security Score (0-100):</strong> Composite score based on length, character variety, entropy, and pattern analysis. 0-39 = Weak (crackable instantly), 40-59 = Fair (crackable in hours/days), 60-79 = Good (crackable in weeks/months), 80-94 = Strong (crackable in years), 95-100 = Very Strong (crackable in centuries). Aim for 80+ for critical accounts.</p>
      
      <p><strong>Entropy (bits):</strong> Measures randomness and unpredictability. Calculated as log2(possible combinations). 40-60 bits = Weak, 60-80 bits = Fair, 80-100 bits = Good, 100-120 bits = Strong, 120+ bits = Very Strong. Each additional bit doubles the cracking difficulty. Modern recommendations suggest 80+ bits for important accounts.</p>
      
      <p><strong>Character Variety Checks:</strong> The analyzer verifies your password contains multiple character types (uppercase, lowercase, numbers, symbols). Using all four types dramatically increases the possible combinations, making brute-force attacks exponentially harder. The tool provides instant visual feedback (‚úì/‚úó) for each requirement.</p>
      
      <p><strong>Pattern Detection:</strong> Identifies weak patterns like sequential characters (abc, 123), repeated characters (aaa, 111), keyboard patterns (qwerty, asdf), common words, and years/dates. These patterns reduce effective entropy and make passwords vulnerable to dictionary and pattern-based attacks. The feedback list warns you about detected weaknesses.</p>
      
      <h2>Leet-Speak Transformation Rules</h2>
      <p>The Memorable mode uses intelligent character substitutions to convert regular words into secure passwords while maintaining readability:</p>
      <ul>
        <li><strong>a ‚Üí @:</strong> Common and highly recognizable substitution</li>
        <li><strong>e ‚Üí 3:</strong> Visual similarity makes it memorable</li>
        <li><strong>i ‚Üí !:</strong> Adds required special character</li>
        <li><strong>o ‚Üí 0:</strong> Classic leet-speak transformation</li>
        <li><strong>s ‚Üí $:</strong> Adds symbol requirement</li>
        <li><strong>t ‚Üí 7:</strong> Subtle numeric addition</li>
      </ul>
      <p>The algorithm applies strategic transformations (not all vowels replaced) to balance security with memorability. Preview shows the exact transformation before generation.</p>
      
      <h2>Best Practices & Recommendations</h2>
      <p><strong>Length Matters Most:</strong> A 20-character password with only lowercase letters is stronger than a 10-character password with all character types. Always prefer longer passwords when possible. Each additional character exponentially increases security.</p>
      
      <p><strong>Use Unique Passwords:</strong> Never reuse passwords across accounts. If one site is breached, attackers will try your credentials everywhere. Use this generator to create unique passwords for every account, then store them in a reputable password manager.</p>
      
      <p><strong>Memorable vs Maximum Security:</strong> Use Memorable mode for passwords you type frequently (master password, work computer login). Use Random mode with password manager for all other accounts (maximum security, no memorization needed).</p>
      
      <p><strong>Enable Multi-Factor Authentication:</strong> Even the strongest password can be compromised through phishing or keyloggers. Always enable 2FA/MFA on important accounts for defense-in-depth security.</p>
      
      <p><strong>Regular Rotation:</strong> Change passwords for critical accounts every 90-180 days. Immediately change passwords if you suspect compromise or if the service reports a data breach.</p>
      
      <h2>Privacy & Security</h2>
      <p>All password generation happens entirely in your browser using cryptographically secure random number generation (crypto.getRandomValues()). No passwords are ever sent to any server, logged, or stored anywhere except your device's local storage (for history, which you control). The tool works completely offline after initial load. Source code is transparent and auditable. Your passwords are 100% private and never leave your device.</p>
    </section>
  </main>

  <footer>ToolsMatic ¬∑ Fast, privacy-first utilities for the web.</footer>


  <script>
    // DOM Elements
    const lengthInput = document.getElementById('length');
    const lengthDisplay = document.getElementById('length-display');
    const upper = document.getElementById('upper');
    const lower = document.getElementById('lower');
    const numbers = document.getElementById('numbers');
    const symbols = document.getElementById('symbols');
    const avoidAmbig = document.getElementById('no-ambig');
    const pronounceable = document.getElementById('pronounceable');
    const baseWords = document.getElementById('base-words');
    const leetSpeak = document.getElementById('leet-speak');
    const addYear = document.getElementById('add-year');
    const addSymbolsMem = document.getElementById('add-symbols-mem');
    const capMode = document.getElementById('cap-mode');
    const leetPreviewBox = document.getElementById('leet-preview-box');
    const leetPreview = document.getElementById('leet-preview');
    const userWordInput = document.getElementById('user-word');
    const userWordGenerate = document.getElementById('user-word-generate');
    const policy = document.getElementById('policy');
    const passwordBox = document.getElementById('password');
    const generateBtn = document.getElementById('generate');
    const regenerateBtn = document.getElementById('regenerate');
    const copyBtn = document.getElementById('copy');
    const modeSelect = document.getElementById('mode');
    const passwordOptions = document.getElementById('password-options');
    const memorableOptions = document.getElementById('memorable-options');
    const passphraseOptions = document.getElementById('passphrase-options');
    const wordsInput = document.getElementById('words');
    const wordsRange = document.getElementById('words-range');
    const separatorInput = document.getElementById('separator');
    const caseMode = document.getElementById('case-mode');
    const addNumber = document.getElementById('add-number');
    const historyList = document.getElementById('history');
    const strengthFill = document.getElementById('strength-fill');
    const strengthLabel = document.getElementById('strength-label');
    const strengthScore = document.getElementById('strength-score');
    const entropyDisplay = document.getElementById('entropy-display');
    const feedbackList = document.getElementById('feedback-list');

    const settingsKey = 'pg-settings-v3';
    const historyKey = 'pg-history-v3';
    const maxHistory = 8;

    // Character sets
    const sets = {
      upper: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
      lower: 'abcdefghijklmnopqrstuvwxyz',
      numbers: '0123456789',
      symbols: '!@#$%^&*()-_=+[]{};:,.<>/?',
      ambig: 'O0o1lIS5B8Z2',
      vowels: 'aeiouAEIOU',
      consonants: 'bcdfghjklmnpqrstvwxyzBCDFGHJKLMNPQRSTVWXYZ'
    };

    // Diceware word list
    const diceWords = [
      'able','about','ace','acid','acorn','actor','adapt','agent','agree','alpha','amber','angle','apple','april','arc','armor','arrow','artist','atom','aura','award','badge','baker','basic','beacon','beard','beaver','begin','beyond','bike','bison','blade','blast','blend','blink','bonus','bounty','breeze','brick','brisk','broom','cabin','cable','cactus','camel','candle','canoe','carbon','cargo','carve','castle','cello','chalk','chant','chase','cheer','chess','chief','cider','civic','clay','clear','cliff','climb','cloak','clock','cloud','clover','cobalt','cocoa','coconut','comic','compass','copper','cosmic','cotton','coyote','crane','crisp','crown','crystal','cubic','curry','daisy','delta','desert','digit','dingo','disco','dizzy','dolphin','dragon','dream','drift','dune','eagle','ember','enjoy','enlist','epic','epoch','equal','estate','ethic','excel','falcon','fancy','feather','fiber','field','finch','flame','flash','flock','fluent','focus','forest','forge','formal','fox','frame','fresh','frost','fusion','galaxy','gamma','garden','gator','gem','giant','glide','globe','glow','gnome','gold','grace','grain','grand','graph','green','grid','groove','grove','guard','guest','guide','harbor','hazel','helium','hero','hinge','honey','honor','horn','hotel','hub','humble','hybrid','ice','icon','idea','iguana','impact','index','ink','input','iris','island','ivory','jade','jazz','jet','jewel','jolly','judge','jungle','jupiter','karma','kayak','keystone','king','kite','kiwi','ladder','laser','lava','leaf','lemon','level','light','linen','lion','logic','lunar','lunch','lynx','magnet','maple','marble','marine','matrix','meadow','melon','metal','meter','metro','micro','midnight','mint','mirror','mist','model','molecule','monkey','moss','motion','mountain','muffin','myth','nebula','nectar','neon','night','noble','north','novel','nucleus','oasis','oak','ocean','octave','omega','onion','opal','orbit','orca','owl','oxygen','palm','panel','paper','parcel','pasta','patch','patio','pearl','pegasus','pepper','petal','photon','piano','pigeon','pilot','pine','pixel','planet','plasma','plume','poem','polar','pond','pulse','puma','pure','python','quartz','quest','quiet','quill','radar','radio','raven','razor','rebel','reef','relic','ribbon','ridge','rider','ripple','river','robot','rocket','rogue','rose','round','rover','ruby','runner','saber','safari','sage','sail','salmon','saturn','scout','scroll','seagull','season','seed','shadow','shard','shark','shelter','shield','ship','signal','silk','silver','sketch','sky','slate','sleet','sling','smith','smoke','snail','snow','solar','sonic','sound','south','space','spark','spear','spell','spice','spider','spike','spirit','splash','spoon','spring','square','stable','stack','stage','stall','star','steam','stellar','stone','storm','story','strand','straw','stream','street','string','strong','studio','sugar','sun','swift','symbol','table','tango','tanker','taper','tartan','tempo','tiger','timber','titan','toast','token','topaz','torch','tower','track','trail','transit','tree','trident','tropic','trust','tulip','tunnel','turbo','turtle','ultra','union','unite','urban','utopia','valley','vapor','vector','velvet','vessel','viking','violet','vision','vista','vivid','vortex','voyage','wagon','water','wave','weave','whale','wheat','whisper','widow','wild','willow','wind','window','wing','winter','wolf','wool','xenon','yacht','yard','year','yellow','young','zebra','zenith','zephyr','zinc','zodiac'
    ];

    // Utility functions
    const randomFrom = (pool) => pool[Math.floor(Math.random() * pool.length)];
    const secureRandom = (max) => {
      const array = new Uint32Array(1);
      crypto.getRandomValues(array);
      return array[0] % max;
    };
    const secureRandomFrom = (pool) => pool[secureRandom(pool.length)];
    
    const clampNumber = (value, min, max, fallback) => {
      const n = parseInt(value, 10);
      if (Number.isNaN(n)) return fallback;
      return Math.min(max, Math.max(min, n));
    };

    // Leet-speak transformation
    const leetMap = {
      'a': '@', 'e': '3', 'i': '!', 'o': '0', 's': '$', 't': '7',
      'A': '@', 'E': '3', 'I': '!', 'O': '0', 'S': '$', 'T': '7'
    };

    const applyLeetSpeak = (text) => {
      let result = '';
      let vowelCount = 0;
      for (let char of text) {
        if (leetMap[char] && Math.random() > 0.3) { // 70% chance to transform
          result += leetMap[char];
          if ('aeiouAEIOU'.includes(char)) vowelCount++;
        } else {
          result += char;
        }
      }
      return result;
    };

    const hardenMemorablePassword = (candidate) => {
      let password = candidate;

      // Guarantee at least one uppercase
      if (!/[A-Z]/.test(password)) {
        password = password.charAt(0).toUpperCase() + password.slice(1);
      }

      // Guarantee at least one number
      if (!/[0-9]/.test(password)) {
        password += (secureRandom(90) + 10).toString();
      }

      // Guarantee at least one symbol
      if (!/[!@#$%^&*()_+\-=[\]{};':"\\|,.<>/?]/.test(password)) {
        const sym = randomFrom('!@#$%&*');
        const pos = secureRandom(password.length + 1);
        password = password.slice(0, pos) + sym + password.slice(pos);
      }

      // Pad to a safer length if needed
      if (password.length < 14) {
        const fillers = [];
        const fillerPool = sets.numbers + sets.symbols;
        for (let i = 0; i < 14 - password.length; i++) {
          fillers.push(secureRandomFrom(fillerPool));
        }
        password += fillers.join('');
      }

      return password;
    };

    const transformMemorablePassword = (input) => {
      if (!input) return '';
      
      const words = input.trim().split(/\s+/).filter(Boolean).slice(0, 5);
      let password = '';
      
      // Apply capitalization
      const capitalizedWords = words.map(word => {
        if (capMode.value === 'title') {
          return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
        } else if (capMode.value === 'first') {
          return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
        } else { // random
          return word.split('').map(c => Math.random() > 0.5 ? c.toUpperCase() : c.toLowerCase()).join('');
        }
      });
      
      // Apply leet-speak
      const transformedWords = leetSpeak.checked 
        ? capitalizedWords.map(w => applyLeetSpeak(w))
        : capitalizedWords;
      
      // Join with separator
      const separator = addSymbolsMem.checked ? randomFrom(['-', '_', '.', '!', '@']) : '-';
      password = transformedWords.join(separator);
      
      // Add symbol prefix if enabled
      if (addSymbolsMem.checked) {
        const symbolPrefix = randomFrom(['!', '@', '#', '$', '%']);
        password = symbolPrefix + password;
      }
      
      // Add year if enabled
      if (addYear.checked) {
        password += new Date().getFullYear();
      }
      
      // Add symbol suffix if enabled
      if (addSymbolsMem.checked) {
        const symbolSuffix = randomFrom(['!', '@', '#', '$', '%']);
        password += symbolSuffix;
      }
      
      return hardenMemorablePassword(password);
    };

    // Update leet-speak preview
    const updateLeetPreview = () => {
      const input = baseWords.value.trim();
      if (input && modeSelect.value === 'memorable') {
        const preview = transformMemorablePassword(input);
        leetPreview.textContent = preview;
        leetPreviewBox.style.display = 'block';
      } else {
        leetPreviewBox.style.display = 'none';
      }
    };

    // Password strength analysis
    const analyzeStrength = (password) => {
      if (!password || password.includes('Click')) return {
        score: 0,
        label: 'Not Generated',
        entropy: 0,
        feedback: [],
        checks: {
          length: false,
          uppercase: false,
          lowercase: false,
          numbers: false,
          symbols: false,
          variety: false
        }
      };

      const checks = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        numbers: /[0-9]/.test(password),
        symbols: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password),
        variety: false
      };

      // Calculate entropy
      let poolSize = 0;
      if (checks.uppercase) poolSize += 26;
      if (checks.lowercase) poolSize += 26;
      if (checks.numbers) poolSize += 10;
      if (checks.symbols) poolSize += 32;
      const entropy = Math.round(password.length * Math.log2(poolSize || 1));

      // Character variety
      const uniqueChars = new Set(password).size;
      checks.variety = uniqueChars >= password.length * 0.5;

      // Base score from entropy and length
      let score = Math.min(100, (entropy / 128) * 100);
      
      // Penalties and bonuses
      const feedback = [];
      
      // Length bonuses/penalties
      if (password.length < 8) {
        score -= 20;
        feedback.push({ type: 'warning', text: 'Password is too short (minimum 8 characters recommended)' });
      } else if (password.length >= 16) {
        score += 5;
        feedback.push({ type: 'success', text: 'Excellent length! Longer passwords are significantly more secure.' });
      }
      
      // Character type bonuses
      let typeCount = [checks.uppercase, checks.lowercase, checks.numbers, checks.symbols].filter(Boolean).length;
      if (typeCount < 3) {
        score -= 15;
        feedback.push({ type: 'warning', text: 'Use multiple character types for better security' });
      } else if (typeCount === 4) {
        score += 10;
        feedback.push({ type: 'success', text: 'Uses all four character types - excellent!' });
      }
      
      // Pattern detection
      if (/(.)\1{2,}/.test(password)) {
        score -= 15;
        feedback.push({ type: 'warning', text: 'Contains repeated characters (aaa, 111)' });
      }
      
      if (/abc|bcd|cde|def|efg|fgh|ghi|hij|ijk|jkl|klm|lmn|mno|nop|opq|pqr|qrs|rst|stu|tuv|uvw|vwx|wxy|xyz|012|123|234|345|456|567|678|789/i.test(password)) {
        score -= 10;
        feedback.push({ type: 'warning', text: 'Contains sequential characters (abc, 123)' });
      }
      
      if (/qwert|asdf|zxcv|12345|password|admin|user|login/i.test(password)) {
        score -= 20;
        feedback.push({ type: 'warning', text: 'Contains common keyboard patterns or words' });
      }
      
      if (/19\d{2}|20\d{2}/.test(password)) {
        score -= 5;
        feedback.push({ type: 'info', text: 'Contains a year - be cautious of predictable dates' });
      }
      
      // Variety bonus
      if (!checks.variety) {
        score -= 10;
        feedback.push({ type: 'warning', text: 'Low character variety - use more diverse characters' });
      }
      
      // Entropy feedback
      if (entropy < 60) {
        feedback.push({ type: 'warning', text: `Low entropy (${entropy} bits) - vulnerable to brute force attacks` });
      } else if (entropy >= 100) {
        feedback.push({ type: 'success', text: `High entropy (${entropy} bits) - extremely resistant to brute force` });
      }
      
      // Clamp score
      score = Math.max(0, Math.min(100, Math.round(score)));
      
      // Determine label
      let label = 'Weak';
      if (score >= 95) label = 'Very Strong';
      else if (score >= 80) label = 'Strong';
      else if (score >= 60) label = 'Good';
      else if (score >= 40) label = 'Fair';
      
      return { score, label, entropy, feedback, checks };
    };

    // Update strength UI
    const updateStrengthUI = (analysis) => {
      strengthScore.textContent = analysis.score > 0 ? analysis.score : '‚Äî';
      strengthLabel.textContent = analysis.label;
      entropyDisplay.textContent = `Entropy: ${analysis.entropy} bits`;
      
      // Update bar
      strengthFill.style.width = `${analysis.score}%`;
      strengthFill.className = 'strength-bar-fill';
      if (analysis.score >= 95) strengthFill.classList.add('strength-very-strong');
      else if (analysis.score >= 80) strengthFill.classList.add('strength-strong');
      else if (analysis.score >= 60) strengthFill.classList.add('strength-good');
      else if (analysis.score >= 40) strengthFill.classList.add('strength-fair');
      else strengthFill.classList.add('strength-weak');
      
      // Update checks
      document.getElementById('check-length').textContent = analysis.checks.length ? '‚úì' : '‚úó';
      document.getElementById('check-length').className = analysis.checks.length ? 'check-icon' : 'x-icon';
      
      document.getElementById('check-uppercase').textContent = analysis.checks.uppercase ? '‚úì' : '‚úó';
      document.getElementById('check-uppercase').className = analysis.checks.uppercase ? 'check-icon' : 'x-icon';
      
      document.getElementById('check-lowercase').textContent = analysis.checks.lowercase ? '‚úì' : '‚úó';
      document.getElementById('check-lowercase').className = analysis.checks.lowercase ? 'check-icon' : 'x-icon';
      
      document.getElementById('check-numbers').textContent = analysis.checks.numbers ? '‚úì' : '‚úó';
      document.getElementById('check-numbers').className = analysis.checks.numbers ? 'check-icon' : 'x-icon';
      
      document.getElementById('check-symbols').textContent = analysis.checks.symbols ? '‚úì' : '‚úó';
      document.getElementById('check-symbols').className = analysis.checks.symbols ? 'check-icon' : 'x-icon';
      
      document.getElementById('check-variety').textContent = analysis.checks.variety ? '‚úì' : '‚úó';
      document.getElementById('check-variety').className = analysis.checks.variety ? 'check-icon' : 'x-icon';
      
      // Update feedback
      feedbackList.innerHTML = '';
      if (analysis.feedback.length > 0) {
        analysis.feedback.forEach(item => {
          const li = document.createElement('li');
          li.className = `feedback-item feedback-${item.type}`;
          li.textContent = item.text;
          feedbackList.appendChild(li);
        });
      } else if (analysis.score > 0) {
        const li = document.createElement('li');
        li.className = 'feedback-item feedback-success';
        li.textContent = '‚úì Password meets all security requirements!';
        feedbackList.appendChild(li);
      }
    };

    // Generate random password
    const generateRandomPassword = () => {
      const length = clampNumber(lengthDisplay.value, 8, 64, 16);
      lengthDisplay.value = length;
      lengthInput.value = length;
      
      let pool = '';
      if (upper.checked) pool += sets.upper;
      if (lower.checked) pool += sets.lower;
      if (numbers.checked) pool += sets.numbers;
      if (symbols.checked) pool += sets.symbols;
      
      if (avoidAmbig.checked) {
        pool = pool.split('').filter(ch => !sets.ambig.includes(ch)).join('');
      }
      
      if (!pool) {
        if (window.ToolsMatic) window.ToolsMatic.showToast('Select at least one character type', 'error');
        return '';
      }
      
      let password = '';
      
      if (pronounceable.checked) {
        // Generate pronounceable password (consonant-vowel pattern)
        const consonants = sets.consonants;
        const vowels = sets.vowels;
        for (let i = 0; i < length; i++) {
          password += i % 2 === 0 ? secureRandomFrom(consonants) : secureRandomFrom(vowels);
        }
        if (numbers.checked) {
          // Replace some chars with numbers
          password = password.split('').map((c, i) => 
            i % 4 === 0 && Math.random() > 0.5 ? secureRandomFrom(sets.numbers) : c
          ).join('');
        }
        if (symbols.checked) {
          // Add symbol at random position
          const pos = secureRandom(password.length);
          password = password.slice(0, pos) + secureRandomFrom(sets.symbols) + password.slice(pos + 1);
        }
      } else {
        // Pure random
        for (let i = 0; i < length; i++) {
          password += secureRandomFrom(pool);
        }
      }
      
      return password.slice(0, length);
    };

    // Generate passphrase
    const generatePassphrase = () => {
      const wordCount = clampNumber(wordsInput.value, 3, 10, 5);
      wordsInput.value = wordCount;
      wordsRange.value = wordCount;
      
      const sep = separatorInput.value || '-';
      const words = [];
      
      for (let i = 0; i < wordCount; i++) {
        let word = secureRandomFrom(diceWords);
        if (caseMode.value === 'upper') word = word.toUpperCase();
        else if (caseMode.value === 'title') word = word[0].toUpperCase() + word.slice(1);
        words.push(word);
      }
      
      let passphrase = words.join(sep);
      
      if (addNumber.checked) {
        passphrase += secureRandom(100);
      }
      
      return passphrase;
    };

    // Main generate function
    const generate = () => {
      let password = '';
      const mode = modeSelect.value;
      
      if (mode === 'password') {
        password = generateRandomPassword();
      } else if (mode === 'memorable') {
        const input = baseWords.value.trim();
        if (!input) {
          if (window.ToolsMatic) window.ToolsMatic.showToast('Enter words to create memorable password', 'error');
          baseWords.focus();
          return;
        }
        password = transformMemorablePassword(input);
      } else if (mode === 'passphrase') {
        password = generatePassphrase();
      }
      
      if (!password) return;
      
      passwordBox.textContent = password;
      const analysis = analyzeStrength(password);
      updateStrengthUI(analysis);
      pushHistory(mode, password, analysis.score);
      persistSettings();
    };

    // History management
    const pushHistory = (mode, password, score) => {
      if (!password || password.includes('Click')) return;
      
      const records = JSON.parse(localStorage.getItem(historyKey) || '[]');
      records.unshift({ mode, value: password, score, timestamp: Date.now() });
      while (records.length > maxHistory) records.pop();
      localStorage.setItem(historyKey, JSON.stringify(records));
      renderHistory();
    };

    const renderHistory = () => {
      const records = JSON.parse(localStorage.getItem(historyKey) || '[]');
      historyList.innerHTML = '';
      
      if (!records.length) {
        const empty = document.createElement('div');
        empty.className = 'muted-text';
        empty.textContent = 'No password history yet. Generated passwords appear here (stored locally only).';
        historyList.appendChild(empty);
        return;
      }
      
      records.forEach(item => {
        const row = document.createElement('div');
        row.className = 'history-item';
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.gap = '12px';
        
        const value = document.createElement('div');
        value.className = 'history-value';
        value.textContent = item.value;
        value.style.flex = '1';
        value.style.fontFamily = "'Courier New', monospace";
        
        const scoreTag = document.createElement('span');
        scoreTag.className = 'tag';
        scoreTag.textContent = `Score: ${item.score || '?'}`;
        scoreTag.style.fontSize = '11px';
        
        const modeTag = document.createElement('span');
        modeTag.className = 'tag';
        modeTag.textContent = item.mode === 'passphrase' ? 'Passphrase' : item.mode === 'memorable' ? 'Memorable' : 'Random';
        
        const copyBtnRow = document.createElement('button');
        copyBtnRow.className = 'ghost';
        copyBtnRow.textContent = 'Copy';
        copyBtnRow.style.fontSize = '13px';
        copyBtnRow.style.padding = '6px 12px';
        copyBtnRow.addEventListener('click', async () => {
          await navigator.clipboard.writeText(item.value);
          if (window.ToolsMatic) window.ToolsMatic.showToast('Copied from history', 'success');
        });
        
        row.appendChild(value);
        row.appendChild(scoreTag);
        row.appendChild(modeTag);
        row.appendChild(copyBtnRow);
        historyList.appendChild(row);
      });
    };

    // Copy to clipboard
    const copy = async () => {
      const value = passwordBox.textContent;
      if (!value || value.includes('Click')) return;
      
      try {
        await navigator.clipboard.writeText(value);
        if (window.ToolsMatic) window.ToolsMatic.showToast('Password copied to clipboard!', 'success');
      } catch (err) {
        if (window.ToolsMatic) window.ToolsMatic.showToast('Copy failed', 'error');
      }
    };

    // Apply policy preset
    const applyPolicy = () => {
      const policyValue = policy.value;
      
      if (policyValue === 'ultra') {
        modeSelect.value = 'password';
        lengthDisplay.value = 32;
        upper.checked = true;
        lower.checked = true;
        numbers.checked = true;
        symbols.checked = true;
        avoidAmbig.checked = false;
      } else if (policyValue === 'nist') {
        modeSelect.value = 'password';
        lengthDisplay.value = 16;
        upper.checked = true;
        lower.checked = true;
        numbers.checked = true;
        symbols.checked = true;
        avoidAmbig.checked = false;
      } else if (policyValue === 'long') {
        modeSelect.value = 'password';
        lengthDisplay.value = 20;
        upper.checked = true;
        lower.checked = true;
        numbers.checked = true;
        symbols.checked = false;
        avoidAmbig.checked = true;
      } else if (policyValue === 'owasp') {
        modeSelect.value = 'password';
        lengthDisplay.value = 14;
        upper.checked = true;
        lower.checked = true;
        numbers.checked = true;
        symbols.checked = true;
        avoidAmbig.checked = true;
      } else if (policyValue === 'diceware') {
        modeSelect.value = 'passphrase';
        wordsInput.value = 5;
        separatorInput.value = '-';
        addNumber.checked = true;
        caseMode.value = 'title';
      }
      
      toggleMode();
      if (policyValue !== 'custom') generate();
    };

    // Toggle mode visibility
    const toggleMode = () => {
      const mode = modeSelect.value;
      passwordOptions.style.display = mode === 'password' ? 'block' : 'none';
      memorableOptions.style.display = mode === 'memorable' ? 'block' : 'none';
      passphraseOptions.style.display = mode === 'passphrase' ? 'block' : 'none';
    };

    // Persist settings
    const persistSettings = () => {
      const payload = {
        mode: modeSelect.value,
        policy: policy.value,
        length: lengthDisplay.value,
        upper: upper.checked,
        lower: lower.checked,
        numbers: numbers.checked,
        symbols: symbols.checked,
        avoidAmbig: avoidAmbig.checked,
        pronounceable: pronounceable.checked,
        leetSpeak: leetSpeak.checked,
        addYear: addYear.checked,
        addSymbolsMem: addSymbolsMem.checked,
        capMode: capMode.value,
        words: wordsInput.value,
        separator: separatorInput.value,
        caseMode: caseMode.value,
        addNumber: addNumber.checked
      };
      localStorage.setItem(settingsKey, JSON.stringify(payload));
    };

    // Load settings
    const loadSettings = () => {
      try {
        const saved = JSON.parse(localStorage.getItem(settingsKey) || '{}');
        if (Object.keys(saved).length === 0) return;
        
        modeSelect.value = saved.mode || 'password';
        policy.value = saved.policy || 'custom';
        lengthDisplay.value = saved.length || 16;
        lengthInput.value = saved.length || 16;
        upper.checked = saved.upper ?? true;
        lower.checked = saved.lower ?? true;
        numbers.checked = saved.numbers ?? true;
        symbols.checked = saved.symbols ?? false;
        avoidAmbig.checked = saved.avoidAmbig ?? false;
        pronounceable.checked = saved.pronounceable ?? false;
        leetSpeak.checked = saved.leetSpeak ?? true;
        addYear.checked = saved.addYear ?? true;
        addSymbolsMem.checked = saved.addSymbolsMem ?? false;
        capMode.value = saved.capMode || 'title';
        wordsInput.value = saved.words || 5;
        wordsRange.value = saved.words || 5;
        separatorInput.value = saved.separator || '-';
        caseMode.value = saved.caseMode || 'lower';
        addNumber.checked = saved.addNumber ?? true;
      } catch (err) {
        // Ignore corrupted state
      }
    };

    // Event listeners
    generateBtn.addEventListener('click', generate);
    regenerateBtn.addEventListener('click', generate);
    copyBtn.addEventListener('click', copy);
    policy.addEventListener('change', applyPolicy);
    modeSelect.addEventListener('change', () => {
      policy.value = 'custom';
      toggleMode();
      persistSettings();
    });
    
    // Length slider sync
    lengthInput.addEventListener('input', () => {
      lengthDisplay.value = lengthInput.value;
      policy.value = 'custom';
      persistSettings();
    });
    lengthDisplay.addEventListener('input', () => {
      lengthInput.value = lengthDisplay.value;
      policy.value = 'custom';
      persistSettings();
    });
    
    // Words slider sync
    wordsRange.addEventListener('input', () => {
      wordsInput.value = wordsRange.value;
      policy.value = 'custom';
      persistSettings();
    });
    wordsInput.addEventListener('input', () => {
      wordsRange.value = wordsInput.value;
      policy.value = 'custom';
      persistSettings();
    });
    
    // Memorable password preview
    baseWords.addEventListener('input', updateLeetPreview);
    leetSpeak.addEventListener('change', updateLeetPreview);
    addYear.addEventListener('change', updateLeetPreview);
    addSymbolsMem.addEventListener('change', updateLeetPreview);
    capMode.addEventListener('change', updateLeetPreview);
    
    // Settings persistence
    [upper, lower, numbers, symbols, avoidAmbig, pronounceable, leetSpeak, addYear, addSymbolsMem, addNumber].forEach(el => {
      el.addEventListener('change', () => {
        policy.value = 'custom';
        persistSettings();
      });
    });
    
    [capMode, separatorInput, caseMode].forEach(el => {
      el.addEventListener('change', () => {
        policy.value = 'custom';
        persistSettings();
      });
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
        e.preventDefault();
        generate();
      }
      if (e.key === 'Escape') {
        baseWords.value = '';
        updateLeetPreview();
      }
    });

    // User word flow
    const useUserWord = () => {
      const seed = userWordInput.value.trim();
      if (!seed) {
        if (window.ToolsMatic) window.ToolsMatic.showToast('Enter a word or phrase first', 'error');
        userWordInput.focus();
        return;
      }

      modeSelect.value = 'memorable';
      policy.value = 'custom';
      leetSpeak.checked = true;
      addYear.checked = true;
      addSymbolsMem.checked = true;
      capMode.value = 'title';
      baseWords.value = seed;
      toggleMode();
      updateLeetPreview();
      persistSettings();
      generate();
    };

    userWordGenerate.addEventListener('click', useUserWord);
    userWordInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        useUserWord();
      }
    });
    
    // Initialize
    loadSettings();
    toggleMode();
    renderHistory();
    if (policy.value !== 'custom') {
      generate();
    }
  </script>
</body>
</html>

